-- 1. PAQUETE DBMS_LOB

CREATE TABLE CLIENTES
(
CODIGO NUMBER,
NOMBRE VARCHAR2(100),
FOTO BFILE,
LONGITUD NUMBER);

INSERT INTO CLIENTES VALUES ( 1,'ROSA',NULL,NULL);
INSERT INTO CLIENTES VALUES ( 2,'PEDRO',NULL,NULL); 
INSERT INTO CLIENTES VALUES ( 3,'ANTONIO',NULL,NULL); 
INSERT INTO CLIENTES VALUES ( 4,'RAUL',NULL,NULL); 

SELECT * FROM CLIENTES;

-- 2. OBTENER TAMAÑO DE ARCHIVO
--     Envio de directorio y id de archivo
CREATE OR REPLACE FUNCTION TAM (DIRECTORIO VARCHAR2, CODIGO NUMBER)
RETURN NUMBER
IS
    FICHERO VARCHAR2(100);
    FOTO BFILE;
BEGIN
    FICHERO:='Cliente0'||CODIGO||'.jpg';
    
    FOTO:=BFILENAME(DIRECTORIO,FICHERO);
    
    IF DBMS_LOB.FILEEXISTS(FOTO)=1 THEN
        RETURN DBMS_LOB.GETLENGTH(FOTO);
    ELSE
        RETURN 0;
    END IF;
END;

-- PROBANDO LA FUNCION ( Retorna tamaño del archivo en bytes )
EXECUTE DBMS_OUTPUT.PUT_LINE(TAM('FICHEROS',2)); 

-- 3. STORE PROCEDURE :: CARGA IMAGEN EN CAMPO FOTO
CREATE OR REPLACE PROCEDURE SPU_CARGA_CLIENTES
IS
	CURSOR CLI IS SELECT * FROM CLIENTES FOR UPDATE;
	FICHERO VARCHAR2(100);
BEGIN
	FOR C1 IN CLI LOOP
		FICHERO:= 'CLIENTE0'||C1.CODIGO||'.JPG';

		UPDATE CLIENTES 
		SET FOTO=BFILENAME( 'FICHEROS',FICHERO),
            LONGITUD=TAM('FICHEROS',C1.CODIGO)
		WHERE CURRENT OF CLI;
		
	END LOOP;
END;
/
-- Ejecutando Store Procedure
EXECUTE SPU_CARGA_CLIENTES;

SELECT * FROM CLIENTES;