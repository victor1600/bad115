-- CREANDO TABLESPACES
CREATE TABLESPACE TBS_TABLA 
DATAFILE 'C:\TEMP\DF_TABLA.DBF' SIZE 10M;

CREATE TABLESPACE TBS_LOB 
DATAFILE 'C:\TEMP\DF_LOB.DBF' SIZE 10M;

-- CREANDO TABLA CON CAMPO LOB
CREATE TABLE PERSONAL (id NUMBER, DATOS VARCHAR(100),
CONTRATO BLOB)
LOB (CONTRATO) STORE AS (TABLESPACE TBS_LOB)
TABLESPACE TBS_TABLA;

-- TIPOS DE TABLESPACES
SELECT SEGMENT_NAME, SEGMENT_TYPE, TABLESPACE_NAME
FROM DBA_SEGMENTS
WHERE TABLESPACE_NAME IN ( 'TBS_TABLA', 'TBS_LOB');  

-- INSERTANDO DATOS
INSERT INTO PERSONAL VALUES ( 1 , 'RIVERA SANCHEZ RAUL' , EMPTY_BLOB());
INSERT INTO PERSONAL VALUES ( 2 , 'GUTIERREZ SILVERA ANA' , EMPTY_BLOB());
INSERT INTO PERSONAL VALUES ( 3 , 'MORALES SUAREZ PETER' , EMPTY_BLOB());
INSERT INTO PERSONAL VALUES ( 4 , 'HUBERT BARTRA EVA' , EMPTY_BLOB());
COMMIT;

SELECT * FROM PERSONAL;

-- PROCEDIMIENTO DE CARGA
CREATE OR REPLACE PROCEDURE CARGA_CONTRATOS
IS
    CURSOR CUR_PERSONAL IS SELECT * FROM PERSONAL FOR UPDATE;
    FICHERO VARCHAR2(100);
    COMENTARIOS BFILE;
    TEMPORAL BLOB;
BEGIN
    FOR C1 IN CUR_PERSONAL LOOP 
        --NOMBRE DEL FICHERO
        FICHERO:='DOCUMENTO'||C1.ID||'.PDF';
        
        --ASOCIAR EL FICHERO AL BFILE
        COMENTARIOS:=BFILENAME('FICHEROS',FICHERO);
        
        --ABRIR EL FICHERO. ES OBLIGATORIO SI QUEREMOS USAR LOADFROMMFILE
        DBMS_LOB.OPEN(COMENTARIOS,DBMS_LOB.LOB_READONLY);
        
        --ES NECESARIO CREAR UN LOB TEMPORAL, PARA INICIALIZAR EL LOCALIZARO
        DBMS_LOB.CREATETEMPORARY(TEMPORAL,TRUE);
        
        -- CARGAMOS EL FICHERO A LA VARIABLE TEMPORAL 
        DBMS_LOB.LOADFROMFILE(TEMPORAL,COMENTARIOS,DBMS_LOB.GETLENGTH(COMENTARIOS));
        
        --MODIFICAMOS LA COLUMNA DE LA TABLA
        UPDATE PERSONAL SET CONTRATO=TEMPORAL WHERE CURRENT OF CUR_PERSONAL;
        
        --CERRAMOS EL FICHERO
        DBMS_LOB.CLOSE(COMENTARIOS);
    END LOOP;
END;
/

EXECUTE CARGA_CONTRATOS;

SELECT * FROM PERSONAL;